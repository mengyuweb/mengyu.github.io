var apiUrl="https://web.aijinseliunian.me/api/",map=new BMapGL.Map("container"),Public=function(){function t(){}var e=t.prototype;return e.fnMap=function(t,e){void 0===t&&(t=116.331398),void 0===e&&(e=39.897445),map.centerAndZoom(new BMapGL.Point(t,e),19),map.enableScrollWheelZoom(!0),map.setHeading(64.5),map.setTilt(73)},e.fnSelect=function(t){for(var e in t)$(t[e]).select2({placeholder:"请选择",minimumResultsForSearch:-1})},e.$ajax=function(t,e,i){void 0===i&&(i="GET");var a=this;return new Promise(function(n,s){$.ajax({type:i,url:apiUrl+t,contentType:"application/json; charset=utf-8",dataType:"json",data:e,success:function(t){n(t)},error:function(t){a.fnAlert("服务器正在更新中...",3)}})})},e.fnTip=function(t){return'<div class="alert alert-dismissible fade show alertDui" role="alert">\n\t\t\t\t\t<div class="iconDui"><span class="iconfont icon-dui"></span></div>'+t+'\n\t\t\t\t\t<button type="button" class="close" data-dismiss="alert" aria-label="Close">\n\t\t\t\t\t\t<span aria-hidden="true">&times;</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>'},e.fnAlert=function(t,e){var i=Math.floor(50*Math.random()+1),a="alert alert-success alert-dismissable";switch(e){case 1:a="alert alert-info alert-dismissable";break;case 2:a="alert alert-warning alert-dismissable";break;case 3:a="alert alert-danger alert-dismissable"}var n='<div id="msg_id_'+i+'" class="alerts"><div class="'+a+'">'+t+"</div></div>";$("body").append(n);var s=$("#msg_id_"+i);setTimeout(function(){s.slideUp(300,function(){s.remove()})},2e3)},t}();define("public",function(){});var p=new Public,MapObj=function(){function t(){this.init(),this.objs={accidentRoad:"",accidenYear:""},this.solution=[]}var e=t.prototype;return e.init=function(){p.fnSelect(["#roadSection","#particularYear"]),p.fnMap(),this.fnAjaxInit(),this.fnClick()},e.fnAjaxInit=function(){var t=this;Promise.all([p.$ajax("getRoadlist"),p.$ajax("getYearlist")]).then(function(e){t.fnOption("#roadSection",e[0]),t.fnOption("#particularYear",e[1]),t.objs.accidentRoad=e[0][0].dictValue,t.objs.accidenYear=e[1][0].dictValue,t.fnMapMarker(1)})},e.fnMapMarker=function(t){p.$ajax("getAccidentlist",this.objs).then(function(e){if(!t&&!e[0])return p.fnAlert("暂无数据"),!1;t&&e[0]&&e[0].accidentAddressLongitude&&e[0].accidentAddressLatitude&&(map.panTo(new BMapGL.Point(e[0].accidentAddressLongitude,e[0].accidentAddressLatitude)),map.setTilt(73));for(var i in e)if(e[i].accidentAddressLongitude&&e[i].accidentAddressLatitude){var a=new BMapGL.Marker(new BMapGL.Point(e[i].accidentAddressLongitude,e[i].accidentAddressLatitude));map.clearOverlays(),map.addOverlay(a)}})},e.fnOption=function(t,e){var i="";for(var a in e)i+='<option value="'+e[a].dictValue+'">'+e[a].dictLabel+"</option>";$(t).html(i);var n=this.objs,s=this;$(t).on("change",function(){var e=$(this).select2("val");"#roadSection"==t?n.accidentRoad=e:n.accidenYear=e,s.fnMapMarker()})},e.fnClick=function(){var t=this;$("#topRightId li").click(function(){var e=$(this).data("id");"measures"==e?t.fnHtmls("measuresHtml","fnMeasures"):"hiddenDanger"==e?t.fnHtmls("hiddenDangerHtml","fnHiddenDanger"):"evaluate"==e&&t.fnHtmls("evaluateHtml","fnEvaluate")})},e.fnHtmls=function(t,e){var i=this;$("#"+t).text()?this[e]():htmlLoad({id:t,fn:function(){return i[e]()}})},e.fnHiddenDanger=function(){p.$ajax("getSecurityThreat",{accidentRoad:this.objs.accidentRoad}).then(function(t){var e="";for(var i in t)e+="<li><span>"+t[i].securityThreatId+"</span><span>"+t[i].securityThreat+"</span></li>";$("#hiddenDangerUi").html(e)}),$("#hiddenDanger").modal("show")},e.fnEvaluate=function(){p.$ajax("getImprovementEvaluation",{accidentRoad:this.objs.accidentRoad}).then(function(t){var e="";for(var i in t)e+='<tr class="heights">\n\t\t\t\t\t\t<th scope="row">'+t[i].kpiDisplay+"</th>\n\t\t\t\t\t\t<td>"+t[i].accidentNumberBefore+"</td>\n\t\t\t\t\t\t<td>"+t[i].accidentNumberAfter+"</td>\n\t\t\t\t\t\t<td>"+t[i].illegalNumberBefore+"</td>\n\t\t\t\t\t\t<td>"+t[i].illegalNumberAfter+"</td>\n\t\t\t\t\t\t<td>"+t[i].economicPerformanceBefore+"</td>\n\t\t\t\t\t\t<td>"+t[i].economicPerformanceAfter+"</td>\n\t\t\t\t\t\t<td>"+t[i].overallMeritBefore+"</td>\n\t\t\t\t\t\t<td>"+t[i].overallMeritAfter+"</td>\n\t\t\t\t\t</tr>";$("#tbodyTr").html(e)}),$("#evaluate").modal("show")},e.fnMeasures=function(){var t=this;this.measures||p.$ajax("getActionlist").then(function(e){e.length&&(t.fnMeasuresOptions(e,1),t.measures=e)}),$("#measures").modal("show")},e.fnMeasuresOptions=function(t,e){var i="";for(var a in t)i+=this.fnMeasuresDiv(t[a]);$("#leftMeasuresOptions").html(i),e&&($("#leftMeasuresLength").text(t.length),$("#moveTab").tooltip({selector:'[data-toggle="tooltip"]'}),this.fnMeasuresClick())},e.fnMeasuresDiv=function(t,e){return void 0===e&&(e="left"),'<div data-id="'+t.actionId+'" class="custom-checkbox '+("right"==e?"active":"")+'"><input type="checkbox" '+("right"==e?"checked":"")+' data-id="'+e+'" class="custom-control-input" id="'+t.actionId+'"><label class="custom-control-label" for="'+t.actionId+'" data-toggle="'+(t.actionName.length>10?"tooltip":"")+'"  title="'+t.actionName+'">'+t.actionName+"</label></div>"},e.fnMeasuresClick=function(){var t=this;$("#selectAll .selectDiv ul").off("click").click(function(){var e=$(this).data("index");if(t.selectUiIndex&&t.selectUiIndex!=e){if($(this).text()){var i=[];$(this).find("li").each(function(t,e){i.push($(e).data("id"))});var a=t.measures,n="",s="",o=0,r=0;for(var c in a)"-1"==i.indexOf(a[c].actionId)?(n+=t.fnMeasuresDiv(a[c]),o++):(s+=t.fnMeasuresDiv(a[c],"right"),r++);$("#leftMeasuresLength").text(o),$("#rightMeasuresIndex").text(r),$("#leftMeasuresOptions").html(n),$("#rightMeasuresOptions").html(s)}else t.fnMeasuresOptions(t.measures,1),$("#leftMeasuresIndex").text(0),$("#rightMeasuresOptions").empty(),$("#rightMeasures .iconSpan").removeClass("iconJian")}$("#moveTab .moveTabIndex").text(e),t.selectUiIndex=e,$("#moveTab").modal("show")}),$("#moveTabSubmit").off("click").click(function(){var e=$("#rightMeasuresOptions .active"),i="",a=[],n=t.solution;if(e.each(function(t,e){i+='<li data-id="'+$(e).data("id")+'">'+$(e).text()+"</li>",a.push($(e).data("id"))}),n.length){for(var s=-1,o=0;o<n.length;o++)if(n[o].solution==t.selectUiIndex){s=o;break}-1!=s?(n[s].solution=t.selectUiIndex,n[s].actionIds=a.toString()):n.push({solution:t.selectUiIndex,actionIds:a.toString()})}else n.push({solution:t.selectUiIndex,actionIds:a.toString()});$("#selectList"+t.selectUiIndex).html(i),$("#moveTab").modal("hide")}),$("#measuresSubmit").off("click").click(function(){p.$ajax("getSolutionScore",JSON.stringify(t.solution),"post").then(function(t){for(var e=t[0],i=1;i<t.length;i++)e.score<t[i].score&&(e=t[i]);$("#selectAll>div .optimal").empty(),$("#selectAll>div").eq(e.solution-1).find(".optimal").html('<div class="iconDui"><span class="iconfont icon-dui"></span></div>'),$("#optimalSolution").html(p.fnTip("已为你选出最优方案"+e.solution))})}),$("#measureBody").off("click").on("click",".list input",function(){var t=$(this).is(":checked"),e=$(this).data("id");t?$(this).parent().addClass("active"):$(this).parent().removeClass("active");var i=$("#"+e+"Measures .iconSpan"),a=$("#"+e+"MeasuresOptions .active").length;a?!i.hasClass("iconJian")&&i.addClass("iconJian"):i.removeClass("iconJian"),$("#"+e+"MeasuresIndex").text(a)}),$("#measureBody .tabBtn>div").off("click").click(function(){var t=$(this).data("id"),e="right"==t?"left":"right",i=$("#"+e+"MeasuresOptions .active");if(!i.length)return!1;var a="";i.each(function(i,n){var s=n.outerHTML.replace(new RegExp(e,""),t);a+=s.slice(0,71)+"checked='checked '"+s.slice(71)}),$("#"+t+"MeasuresOptions").prepend(a),i.remove();var n=$("#"+e+"MeasuresOptions .active").length,s=$("#"+t+"Measures .iconSpan");$("#"+t+"MeasuresIndex").text($("#"+t+"MeasuresOptions .active").length),$("#"+e+"MeasuresIndex").text(n),!s.hasClass("iconJian")&&s.addClass("iconJian"),!n&&$("#"+e+"Measures .iconSpan").removeClass("iconJian"),$("#leftMeasuresLength").text($("#leftMeasuresOptions>div").length)}),$("#measureBody .keyWord").bind("input propertychange",function(){var t=$(this).data("id"),e=$(this).val();if(null==e||""==e)$("#"+t+"MeasuresOptions .unSearch").removeClass("unSearch");else{var i=e;$("#"+t+"MeasuresOptions>div").removeClass("unSearch"),$("#"+t+"MeasuresOptions>div").each(function(){-1==$(this).find("label").html().indexOf(i)&&$(this).addClass("unSearch")})}})},t}();new MapObj;